//Andriod API's

// login Route
app.post('/api_auth',urlencodedParser,function (req, res) {
  var email = req.body.email; 
  var pass = req.body.password;
  //Getting particular moratorium details of user
  db.collection("moratorium").find({email:email}).toArray(function(err, result1) {
    if (err) throw err;
    details=result1
  })
  //Getting details of user
  db.collection("user").find({email:email}).toArray(function(err, result) {
    if (err) throw err;
    userdata=result
  })  
  //Checking Credentials for User Login
  db.collection('user').findOne({email: email, password: pass }, function(err, doc){
    if(err) throw err;
    if(doc) {

      res.send({login_status:"Success",userdata:userdata,details:details})
    } else {

        console.log(email,pass)
        res.send({login_status:"Fail"})
    }
});
})

app.post('/api_reg', urlencodedParser, function (req, res) {
  var username = req.body.username; 
  var email =req.body.email1; 
  var pass = req.body.password; 
  var status=false;
var data =new userModel({ 
    "username": username, 
    "email": email, 
    "password": pass,
    "status":status
}) 
  db.collection('user').findOne({ email: email }, function(err, doc){
    if(err) throw err;
    if(!doc) {
      db.collection('user').insertOne(data,function(err, collection){ 
        if (err) throw err;
        console.log(data);
        logger.log('info',"Record inserted Successfully"); 
        }); 
      res.send({register_status:"Success",userdata:data})
    }else {
        logger.log('info',"Found: " + email);
        res.send({register_status:"Fail,Email already exist!"})
    }

  });

})

app.get("/api_news",(req,res)=>{
  var mysort = { time: -1 };
  db.collection("news").find({}).sort(mysort).toArray(function(err, result) {
    if (err) throw err;
    loginState=false;
    registerState=false;
    registerFail=false;
    logout=false;
    res.send({news:result});  
  });
})
